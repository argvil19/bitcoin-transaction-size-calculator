class BtcSizeFeeEstimator{constructor(){this.P2PKH_IN_SIZE=148,this.P2PKH_OUT_SIZE=34,this.P2SH_OUT_SIZE=32,this.P2SH_P2WPKH_OUT_SIZE=32,this.P2SH_P2WSH_OUT_SIZE=32,this.P2SH_P2WPKH_IN_SIZE=91,this.P2WPKH_IN_SIZE=67.75,this.P2WPKH_OUT_SIZE=31,this.P2WSH_OUT_SIZE=43,this.P2TR_OUT_SIZE=43,this.P2TR_IN_SIZE=57.25,this.PUBKEY_SIZE=33,this.SIGNATURE_SIZE=72,this.SUPPORTED_INPUT_SCRIPT_TYPES=["P2PKH","P2SH","P2SH-P2WPKH","P2SH-P2WSH","P2WPKH","P2WSH","P2TR"],this.defaultParams={input_count:0,input_script:"P2PKH",input_m:0,input_n:0,p2pkh_output_count:0,p2sh_output_count:0,p2sh_p2wpkh_output_count:0,p2sh_p2wsh_output_count:0,p2wpkh_output_count:0,p2wsh_output_count:0,p2tr_output_count:0},this.inputOpts={}}getSizeOfScriptLengthElement(t){if(t<75)return 1;if(t<=255)return 2;if(t<=65535)return 3;if(t<=4294967295)return 5;throw new Error("Size of redeem script is too large")}getSizeOfVarInt(t){if(t<253)return 1;if(t<65535)return 3;if(t<4294967295)return 5;if(t<0x10000000000000000)return 9;throw new Error("Invalid var int")}getTxOverheadVBytes(t,p,u){t="P2PKH"===t||"P2SH"===t?0:.5+this.getSizeOfVarInt(p)/4;return 4+this.getSizeOfVarInt(p)+this.getSizeOfVarInt(u)+4+t}getTxOverheadExtraRawBytes(t,p){p="P2PKH"===t||"P2SH"===t?0:.5+this.getSizeOfVarInt(p)/4;return 3*p}prepareParams(t){var p=parseInt(t.input_count||this.defaultParams.input_count);if(!Number.isInteger(p)||p<0)throw new Error("expecting positive input count, got: "+p);var u=t.input_script||this.defaultParams.input_script;if(-1===this.SUPPORTED_INPUT_SCRIPT_TYPES.indexOf(u))throw new Error("Not supported input script type");var s=parseInt(t.input_m||this.defaultParams.input_m);if(!Number.isInteger(s)||s<0)throw new Error("expecting positive signature count");var r=parseInt(t.input_n||this.defaultParams.input_n);if(!Number.isInteger(r)||r<0)throw new Error("expecting positive pubkey count");var i=parseInt(t.p2pkh_output_count||this.defaultParams.p2pkh_output_count);if(!Number.isInteger(i)||i<0)throw new Error("expecting positive p2pkh output count");var e=parseInt(t.p2sh_output_count||this.defaultParams.p2sh_output_count);if(!Number.isInteger(e)||e<0)throw new Error("expecting positive p2sh output count");var n=parseInt(t.p2sh_p2wpkh_output_count||this.defaultParams.p2sh_p2wpkh_output_count);if(!Number.isInteger(n)||n<0)throw new Error("expecting positive p2sh-p2wpkh output count");var _=parseInt(t.p2sh_p2wsh_output_count||this.defaultParams.p2sh_p2wsh_output_count);if(!Number.isInteger(_)||_<0)throw new Error("expecting positive p2sh-p2wsh output count");var a=parseInt(t.p2wpkh_output_count||this.defaultParams.p2wpkh_output_count);if(!Number.isInteger(a)||a<0)throw new Error("expecting positive p2wpkh output count");var h=parseInt(t.p2wsh_output_count||this.defaultParams.p2wsh_output_count);if(!Number.isInteger(h)||h<0)throw new Error("expecting positive p2wsh output count");t=parseInt(t.p2tr_output_count||this.defaultParams.p2tr_output_count);if(!Number.isInteger(t)||t<0)throw new Error("expecting positive p2tr output count");return this.params={input_count:p,input_script:u,input_m:s,input_n:r,p2pkh_output_count:i,p2sh_output_count:e,p2sh_p2wpkh_output_count:n,p2sh_p2wsh_output_count:_,p2wpkh_output_count:a,p2wsh_output_count:h,p2tr_output_count:t},this.params}getOutputCount(){return this.params.p2pkh_output_count+this.params.p2sh_output_count+this.params.p2sh_p2wpkh_output_count+this.params.p2sh_p2wsh_output_count+this.params.p2wpkh_output_count+this.params.p2wsh_output_count+this.params.p2tr_output_count}getSizeBasedOnInputType(){var t=0,p=0;switch(this.params.input_script){case"P2PKH":t=this.P2PKH_IN_SIZE;break;case"P2SH-P2WPKH":t=this.P2SH_P2WPKH_IN_SIZE,p=107;break;case"P2WPKH":t=this.P2WPKH_IN_SIZE,p=107;break;case"P2TR":t=this.P2TR_IN_SIZE,p=65;break;case"P2SH":var u=1+this.params.input_n*(1+this.PUBKEY_SIZE)+1+1,s=1+this.params.input_m*(1+this.SIGNATURE_SIZE)+this.getSizeOfScriptLengthElement(u)+u,t=36+this.getSizeOfVarInt(s)+s+4;break;case"P2SH-P2WSH":case"P2WSH":u=1+this.params.input_n*(1+this.PUBKEY_SIZE)+1+1,t=36+(p=1+this.params.input_m*(1+this.SIGNATURE_SIZE)+this.getSizeOfScriptLengthElement(u)+u)/4+4,"P2SH-P2WSH"===this.params.input_script&&(t+=35)}return{inputSize:t,inputWitnessSize:p}}calcTxSize(t){this.prepareParams(t);var p=this.getOutputCount(),{inputSize:u,inputWitnessSize:t}=this.getSizeBasedOnInputType(),u=this.getTxOverheadVBytes(this.params.input_script,this.params.input_count,p)+u*this.params.input_count+this.P2PKH_OUT_SIZE*this.params.p2pkh_output_count+this.P2SH_OUT_SIZE*this.params.p2sh_output_count+this.P2SH_P2WPKH_OUT_SIZE*this.params.p2sh_p2wpkh_output_count+this.P2SH_P2WSH_OUT_SIZE*this.params.p2sh_p2wsh_output_count+this.P2WPKH_OUT_SIZE*this.params.p2wpkh_output_count+this.P2WSH_OUT_SIZE*this.params.p2wsh_output_count+this.P2TR_OUT_SIZE*this.params.p2tr_output_count;return{txVBytes:u,txBytes:this.getTxOverheadExtraRawBytes(this.params.input_script,this.params.input_count)+u+t*this.params.input_count,txWeight:4*u}}estimatedFee(t,p){return parseInt(t)*parseInt(p)}formatFeeRange(t,p){t=parseInt(t),1<(p=Number(p))&&(p/=100);p*=t;return t-p+" - "+(t+p)}}module.exports=BtcSizeFeeEstimator;